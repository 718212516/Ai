<!DOCTYPE html><html>
<head>
<meta charset="utf-8"/>
<title>html5formcore</title>
<link rel="stylesheet" href="style.css" type="text/css"/>
<style>
form label{display:inline-block;width:80px;}
form input{margin:5px 0;padding:0;width:150px;height:18px;background:#fff;border:1px solid #ccc;vertical-align:middle;font-family:arial;}
form input[type="search"]{-webkit-appearance:textfield;}
form textarea{margin:5px 0;width:200px;height:60px;background:#fff;border:1px solid #ccc;font-size:12px;font-family:arial;vertical-align:top;overflow-y:auto;}
form .sub{padding:0 5px;width:auto;height:22px;cursor:pointer;}
</style>
</head>
<body>
<form action="#" id="form1">
	<label>placeholder:</label>
	<input type="text" placeholder="army8735" autocomplete="off"/>
	<br/>
	<label>autofocus:</label>
	<input type="text" autofocus/>
	<br/>
	<label>email:</label>
	<input type="email"/>
	<br/>
	<label>required:</label>
	<input required/>
	<br/>
	<label>url:</label>
	<input type="url"/>
	<br/>
	<label>number:</label>
	<input type="number" max="6" step="2"/>
	<br/>
	<label>date:</label>
	<input type="date"/>
	<br/>
	<label>time:</label>
	<input type="time" name="time"/>
	<br/>
	<label>search:</label>
	<input type="search" maxlength="2"/>
	<br/>
	<label>color:</label>
	<input type="color"/>
	<br/>
	<label>pattern中文:</label>
	<input type="text" pattern="^[\u4e00-\u9fa5]+$"/>
	<br/>
	<label>textarea:</label>
	<textarea maxlength="4"></textarea>
	<br/>
	<label>submit:</label>
	<input type="submit" class="sub" value="submit"/>
	<input type="submit" class="sub" value="formnovalidate" formnovalidate="formnovalidate"/>
	<input type="submit" class="sub" value="formmethod" formmethod="post"/>
	<input type="submit" class="sub" value="formtarget" formtarget="_blank"/>
	<input type="submit" class="sub" value="formenctype" formenctype="multipart/form-data"/>
	<input type="submit" class="sub" value="提交下面这个form" form="form2"/>
	<input type="submit" class="sub" value="提交下面novalidate" form="form2" formnovalidate="formnovalidate"/>
</form>
<form action="#" id="form2">
	<label>email:</label>
	<input type="email" required/>
</form>
<pre class="brush:js">//html5formcore
$$.def('html5formcore', '../plugin/html5formcore.js');
$$.use('html5formcore', function() {
	$('form').html5formcore({
		submit: function() {
			alert('校验通过，可以提交');
			return false;
		}
	});
})
//说明
浏览器原生模拟html5form。在支持的高级浏览器中，此脚本基本没有运行效果；ie等不支持的会做某些模拟。
共有：novalidate属性、placeholder属性、autofocus功能、多种input类型、自定义pattern属性、输入长度限制、submit按钮的各种新属性支持。
在没有通过校验时提交，这个提交不会成功。
//API
$('form').html5formcore(options);
options为传入的对象，它有以下属性：{
	placeholder: function(v), //在input的placeholder发生改变时触发，this指向对应的input，v为当前状态是否为占位符状态
	valid: function(type, v), //在input需要校验时（如blur、提交前）触发，this指向对应的input，type为校验类型；当type为number并且min和max定义时，第2个参数v为超过的范围
	input: function(), //当需要校验的input发生改变（DOM input事件）时触发；ie下由于不支持，可以考虑替代的onpropertychange不完美（改变class也会触发），所以改为focus时触发
	submit: function(cb) //通过html5form的校验后提交表单时触发；cb为回调函数，返回值和jQuery.submit(cb)效果相同
}</pre>
<pre class="brush:js">(function() {

	var TYPE_VALID = {
			'url': /^[a-zA-z]+:\/\/[^\s]*$/,
			'email': /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,
			'number': /^\.*\d+$/,
			'date': /^\d{2,4}-\d{1,2}-\d{1,2}$/,
			'time': /^\d{1,2}:\d{1,2}(:\d{1,2}(\.\d{1,3})?)?$/,
			'color': /^#[a-z\d]{3,6}$/
		};
	$.fn.html5formcore = function(options) {
		options = $.extend({
			placeholder: function() {},
			valid: function() {},
			input: function() {},
			submit: function() {}
		}, options);
		this.each(function(i, o) {
			//仅限1个表单对象
			var form = $(o);
			//验证节点
			if(o.nodeName != 'FORM') return;
			var inputs = form.find(':input:not(:button, :submit, :radio, :checkbox)'),
				submits = form.find('input:submit'),
				input = document.createElement('input'),
				autofocus = 'autofocus' in input,
				placeholder = 'placeholder' in input,
				//required = 'required' in input,
				//maxlength = 'maxlength' in input,
				validArray = [];
			inputs.each(function(index) {
				var item = $(this),
					type = (item.attr('type') || 'text').toLowerCase();
				//placeholder占位符
				if(!placeholder && item.attr('placeholder')) {
					var ph = item.attr('placeholder'),
						last,
						place; //开关，标明input当前是否是占位符状态。
					//占位符为空字符串无效
					if(ph.length) {
						function focus() {
							//打开状态下认为是占位符
							if(place) {
								item.val('');
								place = false
								if(last != place) {
									options.placeholder.call(item[0], false);
								}
							}
							last = place;
						}
						function blur() {
							//离开时如有输入数据开关关闭，否则打开
							if(item.val() == '') {
								item.val(ph);
								place = true;
								if(last != place) {
									options.placeholder.call(item[0], true);
								}
							}
							last = place;
						}
						item.focus(focus).blur(blur);
						//初始化判断，因为ie和ff会在刷新页面后可能autocomplete遗留表单数据，此时占位符就成为遗留的默认数据；也可能在js执行前有用户输入。唯一的缺点是假如在js执行前用户输入的和占位符相同，会被误认为占位符，可忽视。
						if(ph == item.val() || item.val() == '') {
							last = place = true;
							item.val(ph);
							options.placeholder.call(item[0], true);
						}
						else {
							last = place = false;
							options.placeholder.call(item[0], false);
						}
					}
				}
				//maxlength，只有ie的textarea不支持，需模拟
				var maxLength = parseInt(item.attr('maxlength'));
				if(this.nodeName == 'TEXTAREA' && window.attachEvent && !isNaN(maxLength)) {
					function input() {
						var v = item[0].value;
						if(v.length > maxLength) {
							var i,
								bookmark,
								oS = document.selection.createRange(),
								oR = document.body.createTextRange();
							oR.moveToElementText(item[0]);
							bookmark = oS.getBookmark();
							for (i = 0; oR.compareEndPoints('StartToStart', oS) &lt; 0 && oS.moveStart("character", -1) !== 0; i++) {
								//ie的换行是\r\n，算2个字符长度
								if(v.charAt(i) == '\n') {
									i++;
								}
							}
							item.val(v.substr(0, i - 1) + v.substr(i, v.length));
							//模拟光标位置
							if(v.length != i) {
								var range = item[0].createTextRange();
								range.collapse(true);
								range.moveEnd('character', i - 1);
								range.moveStart('character', i - 1);
								range.select();
							}
						}
					}
					this.attachEvent('onpropertychange', input);
					input();
				}
				//autofocus自动聚焦
				if(!autofocus && this.getAttribute('autofocus') != null) {
					item.focus();
				}
				//required
				if(this.getAttribute('required') != null) {
					item.blur(function() {
						if(item.val().trim() == '') {
							validArray[index] = true;
							if(!form.attr('novalidate') && !item.prop('disabled') && item.is(':visible')) {
								options.valid.call(item[0], 'required');
							}
						}
					});
				}
				//几种input类型的校验
				var typeValid = TYPE_VALID[type];
				if(this.nodeName == 'INPUT' && typeValid) {
					item.blur(function() {
						var v = item.val().trim();
						if(v.length && !typeValid.test(v)) {
							validArray[index] = true;
							if(!form.attr('novalidate') && !item.prop('disabled') && item.is(':visible')) {
								options.valid.call(item[0], type);
							}
						}
					});
				}
				//number类型另附验证范围
				if(type == 'number') {
					var max = parseFloat(item.attr('max')),
						min = parseFloat(item.attr('min'));
					if(!isNaN(max)) {
						item.blur(function() {
							var v = item.val().trim();
							if(TYPE_VALID['number'].test(v)) {
								v = parseFloat(v);
								if(v > max) {
									validArray[index] = true;
									if(!form.attr('novalidate') && !item.prop('disabled') && item.is(':visible')) {
										options.valid.call(item[0], 'max', max);
									}
								}
							}
						});
					}
					if(!isNaN(min)) {
						item.blur(function() {
							var v = item.val().trim();
							if(TYPE_VALID['number'].test(v)) {
								v = parseFloat(v);
								if(v &lt; min) {
									validArray[index] = true;
									if(!form.attr('novalidate') && !item.prop('disabled') && item.is(':visible')) {
										options.valid.call(item[0], 'min', min);
									}
								}
							}
						});
					}
				}
				//自定义pattern，只支持text类型
				var pattern = item.attr('pattern');
				if(pattern && pattern.length && type == 'text') {
					pattern = new RegExp(pattern);
					item.blur(function() {
						var v = item.val().trim();
						if(v.length && !pattern.test(v)) {
							validArray[index] = true;
							if(!form.attr('novalidate') && !item.prop('disabled') && item.is(':visible')) {
								options.valid.call(item[0], 'pattern');
							}
						}
					});
				}
				//所有的:input有改动时都要触发回调，ie下由于不支持input事件，改为focus
				function onInput() {
					options.input.call(item[0], 'input');
				}
				if(window.addEventListener) {
					this.addEventListener('input', onInput, false);
				}
				else {
					item.focus(onInput);
				}
			});
			//submit按钮的多项html5属性暂时无法判断浏览器是否原生支持，采用autofocus判断代替
			submits.each(function(index) {
				var nosupport = !autofocus,
					item = $(this),
					formAttr = item.attr('form'),
					formObj,
					formMethod = item.attr('formmethod'),
					formTarget = item.attr('formtarget'),
					formAction = item.attr('formaction'),
					formEnctype = item.attr('formenctype '),
					formNovalidate = item.attr('formnovalidate');
				//formObj在ie下未指定时会返回节点本身
				if(formAttr && $.isString(formAttr)) {
					formObj = $('#' + formAttr);
				}
				else {
					formObj = form;
				}
				if(nosupport && formMethod) {
					item.click(function() {
						formObj.attr('method', formMethod);
					});
				}
				if(nosupport && formTarget) {
					item.click(function() {
						formObj.attr('target', formTarget);
					});
				}
				if(nosupport && formAction) {
					item.click(function() {
						formObj.attr('action', formAction);
					});
				}
				if(nosupport && formEnctype) {
					item.click(function() {
						formObj.attr('formenctype', formEnctype);
					});
				}
				if(formNovalidate) {
					item.click(function() {
						formObj.attr('novalidate', 'novalidate');
					});
				}
				else {
					item.click(function() {
						formObj.removeAttr('novalidate');
					});
				}
				item.click(function() {
					formObj.submit();
					return false;
				});
			});

			form.submit(function() {
				inputs.blur(); //全部触发可能存在的校验
				var validResult = true;
				if(!form.attr('novalidate')) {
					validArray.forEach(function(item, i) {
						var input = inputs.eq(i);
						if(item && !input.prop('disabled') && input.is(':visible')) {
							validResult = false;
						}
					});
				}
				//本身通过html5校验，如有传入callback，返回callback的值
				if(validResult && $.isFunction(options.submit)) {
					validResult = options.submit.call(this) !== false;
				}
				return validResult;
			});
		});
	}

})();</pre>

<script src="../Ai.js"></script>
<script>
	$$.def('html5formcore', '../plugin/html5formcore.js');
	$$.use('html5formcore', function() {
		$('form').html5formcore({
			submit: function() {
				alert('校验通过，可以提交');
				return false;
			}
		});
	})
</script>
<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="jssc5" style="position:absolute;left:-9999px;">
	<param name="movie" value="../jssc5.swf"/>
	<param name="flashvars" value="find=brush&lang=chinese&url=../jssc5.swf"/>
	<embed src="../jssc5.swf" flashvars="find=brush&lang=chinese&url=../jssc5.swf" name="jssc5" type="application/x-shockwave-flash" style="position:absolute;left:-9999px;"/>
</object>
</body>
</html>